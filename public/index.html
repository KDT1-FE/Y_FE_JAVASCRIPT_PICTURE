<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>내담자등록관리</title>
		<link rel="icon" type="image/png" href="/assets/image/logo2.png" />
		<link rel="stylesheet" href="./assets/css/common.min.css" />
		<link rel="stylesheet" href="./assets/css/main.min.css" />
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous" />
		<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/xeicon@2.3.3/xeicon.min.css" />
	</head>
	<body>
		<nav class="navbar navbar-expand-lg bg-body-tertiary">
			<div class="container-fluid">
				<a href="/" class="navbar-brand">
					<img src="/assets/image/logo2.png" alt="로고" />
					<span>내담자등록관리</span>
				</a>
				<span id="nickname" class="ms-auto mx-3">로그인 후 이용해주세요</span>
				<ul class="navbar-nav">
					<li class="nav-item">
						<button type="button" id="login" class="btn btn-danger" onClick="location.href='/sub/login.html'">로그인</button>
						<button type="button" id="logout-btn" class="btn btn-dark">로그아웃</button>
					</li>
				</ul>
			</div>
		</nav>
		<main>
			<div class="list-container">
				<div id="search-area">
					<div class="search-wrap">
						<input type="text" class="form-control" id="search-input" />
						<div class="btn-inner">
							<button type="submit" id="search-btn">
								<i class="xi xi-search"></i>
							</button>
							<button type="button" id="reset-btn">
								<i class="xi xi-refresh"></i>
							</button>
						</div>
					</div>
					<div class="btns-wrap">
						<button type="button" class="btn" id="create-btn">신규등록</button>
						<button type="button" class="btn" id="delete-btn">선택삭제</button>
					</div>
				</div>

				<div class="list-wrapper">
					<div class="d-flex align-items-center justify-content-between">
						<div>
							<input type="checkbox" id="selectall" name="selectall" value="selectall" onclick="selectAll(this)" />
							<label for="selectall">전체선택</label>
						</div>
						<div class="filter-wrap mb-10" id="filter-area">
							<input type="checkbox" id="filter-counseling" value="상담중" />
							<label for="filter-counseling">상담</label>
							<input type="checkbox" id="filter-conclusion" value="종결" />
							<label for="filter-conclusion">종결</label>
							<input type="checkbox" id="filter-treatment" value="치료중" />
							<label for="filter-treatment">치료</label>
						</div>
					</div>
					<div id="list-area"></div>
				</div>
			</div>
		</main>
		<div class="loading-container">
			<img src="/assets/image/loading.gif" alt="로딩 중" />
		</div>
		<script src="/__/firebase/8.6.5/firebase-app.js"></script>
		<script src="/__/firebase/8.6.5/firebase-auth.js"></script>
		<script src="/__/firebase/8.6.5/firebase-firestore.js"></script>
		<script src="/__/firebase/8.6.5/firebase-storage.js"></script>
		<script src="./assets/js/firebase.js"></script>
		<script src="./assets/js/login.js"></script>
		<script src="./assets/js/loading.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
		<script>
			let profileListWrap = document.getElementById('list-area');
			const createBtn = document.getElementById('create-btn');
			const deleteBtn = document.getElementById('delete-btn');
			const searchBtn = document.getElementById('search-btn');
			const searchInput = document.getElementById('search-input');
			const resetBtn = document.getElementById('reset-btn');
			const auth = firebase.auth();

			showLoadingImage();

			// 초기 렌더링
			const render = function () {
				db.collection('person')
					.get()
					.then((result) => {
						let profileList = '';
						result.forEach((doc) => {
							let btnClass = '';

							// 상담종류에 따라 버튼 색상 달라짐
							if (doc.data().sort === '상담중') {
								btnClass = 'btn-primary';
							} else if (doc.data().sort === '치료중') {
								btnClass = 'btn-danger';
							} else if (doc.data().sort === '종결') {
								btnClass = 'btn-warning';
							}

							profileList += `
			   <a href="./sub/sub.html?id=${doc.id}" class="list-item card">
				<input type="checkbox" name="selection" value="${doc.data().name}" onclick="checkSelectAll()"/>
			     <p class="card-img-wrap">
			       <img src="${doc.data().image}" class="card-img-top" />
			     </p>
			     <div class="card-body">

			     <span class="card-text">${doc.data().name}</span>
			     <span class="card-text">/ ${doc.data().gender}</span>
			     <span class="card-text">/ ${doc.data().age}</span>
				<p class="card-text user-text">담당 상담사 : ${doc.data().currentUser}</p>
				<p class="card-text memo-text">${doc.data().memo}</p>
			     <p class="btn ${btnClass}">${doc.data().sort}</p>
			   </div>
			   </a>
			`;
						});

						profileListWrap.innerHTML = profileList;
						hideLoadingImage();
					});
			};

			render();

			// 프로필 새로 등록할 페이지로 이동
			const createList = function () {
				window.location.href = './sub/regis.html';
			};

			// 프로필 삭제하기
			const deleteList = function () {
				let deleteList = [];

				const checkboxes = document.querySelectorAll('input[name="selection"]:checked');
				console.log(checkboxes);

				checkboxes.forEach((checkbox) => {
					const checkedParent = checkbox.closest('a');
					let docIdToDelete = checkedParent.getAttribute('href').split('id=')[1];
					deleteList.push(docIdToDelete);
				});

				const currentUser = firebase.auth().currentUser;
				if (!currentUser) {
					alert('로그인 후에 사용 가능합니다');
					window.location.href = '/sub/login.html';
					return;
				}

				Promise.all(deleteList.map((docId) => db.collection('person').doc(docId).get()))
					.then((docs) => {
						const deletableDocs = docs.filter((doc) => doc.data().uid === currentUser.uid);
						if (deletableDocs.length !== deleteList.length) {
							alert('작성자만 삭제할 수 있습니다');
							return;
						}

						const confirmed = window.confirm('정말로 삭제하시겠습니까?');

						if (confirmed) {
							Promise.all(deleteList.map((docId) => db.collection('person').doc(docId).delete()))
								.then(() => {
									alert('삭제되었습니다');
									render();
								})
								.catch((error) => {
									console.error('Error deleting document: ', error);
								});
						} else {
							// 취소를 선택한 경우
							console.log('삭제 작업이 취소되었습니다.');
						}
					})
					.catch((error) => {
						console.error('Error getting document: ', error);
					});
			};

			// 검색하기
			function searchList() {
				const inputValue = searchInput.value;

				db.collection('person')
					.where('name', '>=', inputValue)
					.where('name', '<=', inputValue + '\uf8ff')
					.get()
					.then((result) => {
						let profileList = '';

						if (result.empty) {
							profileList = '<p class="text-center w-100">검색 결과가 없습니다.</p>';
						} else {
							result.forEach((doc) => {
								let btnClass = '';

								if (doc.data().sort === '상담중') {
									btnClass = 'btn-primary';
								} else if (doc.data().sort === '치료중') {
									btnClass = 'btn-danger';
								} else if (doc.data().sort === '종결') {
									btnClass = 'btn-warning';
								}

								profileList += `
							<a href="./sub/sub.html?id=${doc.id}" class="list-item card">
				<input type="checkbox" name="selection" value="${doc.data().name}" onclick="checkSelectAll()"/>
			     <p class="card-img-wrap">
			       <img src="${doc.data().image}" class="card-img-top" />
			     </p>
			     <div class="card-body">

			     <span class="card-text">${doc.data().name}</span>
			     <span class="card-text">/ ${doc.data().gender}</span>
			     <span class="card-text">/ ${doc.data().age}</span>
				<p class="card-text user-text">담당 상담사 : ${doc.data().currentUser}</p>
				<p class="card-text memo-text">${doc.data().memo}</p>
			     <p class="btn ${btnClass}">${doc.data().sort}</p>
			   </div>
			   </a>
					`;
							});
						}

						profileListWrap.innerHTML = profileList;
					});
			}

			resetBtn.addEventListener('click', function () {
				location.reload();
			});
			searchInput.addEventListener('keypress', function (event) {
				if (event.key === 'Enter') {
					searchList();
				}
			});
			searchBtn.addEventListener('click', searchList);
			createBtn.addEventListener('click', createList);
			deleteBtn.addEventListener('click', deleteList);
			searchBtn.addEventListener('click', searchList);

			// 체크박스 전체선택 및 해제
			function checkSelectAll() {
				// 전체 체크박스
				const checkboxes = document.querySelectorAll('input[name="selection"]');
				// 선택된 체크박스
				const checked = document.querySelectorAll('input[name="selection"]:checked');
				// select all 체크박스
				const selectAll = document.querySelector('input[name="selectall"]');

				if (checkboxes.length === checked.length) {
					selectAll.checked = true;
				} else {
					selectAll.checked = false;
				}
			}

			function selectAll(selectAll) {
				const checkboxes = document.getElementsByName('selection');

				checkboxes.forEach((checkbox) => {
					checkbox.checked = selectAll.checked;
				});
			}

			function sortFiltering() {
				const filterCheckboxes = document.querySelectorAll('#filter-area input[type="checkbox"]');
				let checkedList = [];

				filterCheckboxes.forEach((checkbox) => {
					checkbox.addEventListener('change', () => {
						// 체크박스 상태에 따라 원하는 작업을 수행하도록 작성
						if (checkbox.checked) {
							// 체크될 때의 동작
							checkedList.push(checkbox.value);
							console.log(checkedList);

							// 추가 작업을 여기에 작성
						} else {
							// 체크 해제될 때의 동작
							checkedList = checkedList.filter((item) => item !== checkbox.value);
							console.log(checkedList);

							// 추가 작업을 여기에 작성
						}
						filteredRender(checkedList);
					});
				});
			}

			// 상담종류 필터링
			function filteredRender(selectedSorts) {
				let query = db.collection('person');

				if (selectedSorts.length > 0) {
					query = query.where('sort', 'in', selectedSorts);
				}

				query.get().then((result) => {
					let profileList = '';
					result.forEach((doc) => {
						let btnClass = '';

						if (doc.data().sort === '상담중') {
							btnClass = 'btn-primary';
						} else if (doc.data().sort === '치료중') {
							btnClass = 'btn-danger';
						} else if (doc.data().sort === '종결') {
							btnClass = 'btn-warning';
						}

						profileList += `
								<a href="./sub/sub.html?id=${doc.id}" class="list-item card">
								<input type="checkbox" name="selection" value="${doc.data().name}" onclick="checkSelectAll()"/>
								<p class="card-img-wrap">
								<img src="${doc.data().image}" class="card-img-top" />
								</p>
								<div class="card-body">

								<span class="card-text">${doc.data().name}</span>
								<span class="card-text">/ ${doc.data().gender}</span>
								<span class="card-text">/ ${doc.data().age}</span>
								<p class="card-text user-text">담당 상담사 : ${doc.data().currentUser}</p>
								<p class="card-text memo-text">${doc.data().memo}</p>
								<p class="btn ${btnClass}">${doc.data().sort}</p>
								</div>
								</a>
								`;
					});

					profileListWrap.innerHTML = profileList;
					hideLoadingImage();
				});
			}

			// 페이지 로드 시 체크박스 변경 이벤트 핸들러를 등록
			window.addEventListener('DOMContentLoaded', sortFiltering);
		</script>
	</body>
</html>

